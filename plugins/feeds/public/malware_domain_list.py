import re
from datetime import datetime, timedelta
import logging

from core.observables import Url
from core.feed import Feed
from core.errors import ObservableValidationError


class MalwareDomainList(Feed):

    default_values = {
        "frequency": timedelta(hours=1),
        "name": "MalwareDomainList",
        "source": "http://www.malwaredomainlist.com/hostslist/mdl.xml",
        "description":
            "MalwareDomainList update. This feed shows the latest urls which have been added to our list.",
    }

    def update(self):
        for item in self.update_xml('item',
                                    ["title", "link", "description", "guid"]):
            self.analyze(item)

    def analyze(self, item):
        # Create the new URL and store it in the DB
        url = re.search(r"Host: (?P<url>[^,]+),",
                        item['description']).group('url')

        context = {}
        context['source'] = self.name
        context['description'] = re.search(
            r"Description: (?P<description>.*)$",
            item['description']).group('description')
        context['guid'] = item['guid']
        date_string = re.search(r"\((?P<date>.*)\)",
                                item['title']).group('date')
        context['date_added'] = datetime.strptime(date_string, "%Y/%m/%d_%H:%M")

        try:
            url = Url.get_or_create(value=url)
            url.add_context(context)
            url.add_source("feed")
            url.tag(['malware', 'crimeware'])
        except ObservableValidationError as e:
            logging.error(e)
