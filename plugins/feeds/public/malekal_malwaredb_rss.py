from datetime import datetime, timedelta
import logging

from core.observables import Url, Hostname, Ip
from core.feed import Feed
from core.errors import ObservableValidationError


class MalekalMalwareDBURL(Feed):

    default_values = {
        "frequency": timedelta(hours=1),
        "name": "MalekalMalwareDBURL",
        "source": "http://malwaredb.malekal.com/export.php?type=url",
        "description": "Malekal MalwareDB IP / Domain / URL Feed",
    }

    def update(self):
        for maldict in self.update_xml('item', ["date", "domain", "url", "ip", "category"]):
            self.analyze(maldict)

    def analyze(self, maldict):
        # Create the new URL and store it in the DB

        context = {}
        observable_url = maldict['url']
        observable_ip = maldict['ip']
        observable_hostname = maldict['domain']
        observable_tag = maldict['category']
        context['source'] = self.name
        context['category'] = maldict['category']
        context['hostname'] = maldict['domain']
        context['url'] = maldict['url']
        context['ip'] = maldict['ip']
        date_string = maldict['date']
        context['date_added'] = datetime.strptime(date_string, "%Y-%m-%d %H:%M:%S")

        try:
            url = Url.get_or_create(value=observable_url)
            url.add_context(context)
            url.add_source("feed")
            url.tag(observable_tag)
        except ObservableValidationError as e:
            logging.error(e)

        try:
            ip = Ip.get_or_create(value=observable_ip)
            ip.add_context(context)
            ip.add_source("feed")
            ip.tag(observable_tag)
        except ObservableValidationError as e:
            logging.error(e)

        try:
            hostname = Hostname.get_or_create(value=observable_hostname)
            hostname.add_context(context)
            hostname.add_source("feed")
            hostname.tag(observable_tag)
        except ObservableValidationError as e:
            logging.error(e)
